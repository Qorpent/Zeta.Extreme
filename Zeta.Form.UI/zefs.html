<!DOCTYPE html>
<html>
<head>
    <title>...</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <script src="scripts/dateformat.js" type="text/javascript"></script>
    <script src="scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="scripts/jquery-ui.min.js" type="text/javascript"></script>
    <script src="scripts/bootstrap.js" type="text/javascript"></script>
    <script src="scripts/bootstrap-datepicker.js" type="text/javascript"></script>
    <script src="scripts/jquery.number.min.js" type="text/javascript"></script>
    <script src="scripts/stopparentscroll.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="styles/zefs-print.css">
    <link rel="stylesheet" type="text/css" href="styles/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="styles/bootstrap-responsive.min.css">
    <!--<link rel="stylesheet" type="text/css" href="styles/font-awesome.min.css">-->
    <link rel="stylesheet" type="text/css" href="styles/zefs-forms.css">
    <link rel="stylesheet" type="text/css" href="styles/zeta.css">
    <link rel="stylesheet" type="text/css" href="styles/zefs.css">
    <link rel="stylesheet" type="text/css" href="styles/zefs-attacher.css">
    <link rel="stylesheet" type="text/css" href="styles/zefs-chat.css">
    <link rel="stylesheet" type="text/css" href="styles/zeta-floatmenu.css">

    <script src="scripts/loaders.js" type="text/javascript"></script>
    <script src="scripts/jsonformatter.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="styles/jsformatter.css">

    <script type="text/javascript">
        var useStatic = true;
        var serversState = new Object();

        (function() {
            var global = window.loadBalancer = this;
            
            var serversMap = [
                {
                    'host' : 'corp-assoi.ugmk.com',
                    'protocol' : 'https',
                    'apps' : [
                        'zefs',
                        'zefs1',
                        'zefs2',
                        'zefs3',
                        'zefs4'
                    ]
                },

                {
                    'host' : 'admin-assoi.ugmk.com',
                    'protocol' : 'https',
                    'apps' : [
                        'zefs',
                        'zefs1',
                        'zefs2',
                        'zefs3',
                        'zefs4'
                    ]
                }
            ];

            this.getMostFreeServer = function() {
                this.getStatistics = function(
                    protocol,
                    host,
                    application
                ) {         
                    $.ajax(
                        {
                            url : protocol + '://' + host + '/zefs/' + application + '/nodeload.json.qweb',
                            xhrFields: {
                                withCredentials: true
                            },
                            crossDomain : true,
                            dataType : 'json',
                            success: function(json) {
                                serversState[host].appHandled++;
                                serversState[host][application] = json.Availability;
                            },
                            timeout : 500
                        }
                    ).error(
                        function() {
                            serversState[host].appHandled++;
                            serversState[host][application] = 0;
                        }
                    );
                },
                
                this.waitForComplete = function() {
                    for(i = 0; i < serversMap.length; i++) {
                        if(serversState[serversMap[i].host]) {
                            if(
                                serversState[serversMap[i].host].appHandled != serversMap[i].apps.length
                            ) {
                                return false;
                            }
                        } else {
                            return false;
                        }
                    }
                    
                    return true;
                };
            
                for(i = 0; i < serversMap.length; i++) {
                    serversState[serversMap[i].host] = new Object();
                    serversState[serversMap[i].host].appHandled = 0;
                
                    for(k = 0; k < serversMap[i].apps.length; k++) {
                        this.getStatistics(
                            serversMap[i].protocol,
                            serversMap[i].host,
                            serversMap[i].apps[k]
                        );
                    }
                }
                
                setTimeout(this.waitForComplete, 2000);
               // return serversMap[sa.indexOf(sa.max())];
            };

            $(document).ready(
                function() {
                    global.getMostFreeServer();
                }
            );
        })();
    </script>
</head>
<body>
</body>
</html>