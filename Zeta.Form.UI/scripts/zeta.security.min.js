var siteroot = document.location.pathname.match("^/([\\w\\d_\-]+)?/")[0];
var root = window.qorpent = window.qorpent || {};
//root = root.zeta = root.zeta || {};
root = root.security = root.security || {};

!function($) {
    var Console = function() {
        this.auth = {
            admin : false,
            developer : false,
            datamaster : false,
            authorized : false,
            logonname : ""
        }

        this.roles = []
    }

    Console.prototype = {
        widgets : [],
        registerWidget : function(e) {
            this.widgets.push(e);
        },
        // Setup layout
        layout : {
            position : {
                layoutHeader : "header",
//              layoutBodyLeft : "body-left",
                layoutBodyMain : "body-main"
            },
            header : $('<div id="consoleHeader"/>').append(
                $('<div class="navbar"/>').append(
                    $('<div class="navbar-inner"/>')
                )
            ),
            body : $('<div id="consoleBody" class="console-body"/>'),
            /*.append($('<div/>').append($('<section/>'))
                $('<div class="span3 console-sidebar" />').append($('<ul class="nav nav-list"/>')),
                 $('<div class="span9" />').append($('<section/>'))
            ),*/
            footer : $('<div id="consoleFooter"/>'),
            add : function(e) {
                $(e.body).addClass(e.name)
                if (e.float != "none") $(e.body).addClass("pull-" + e.float)
                if (e.pos == this.position.layoutHeader) $('#consoleHeader > .navbar > .navbar-inner').append(e.body);
                //  if (e.pos == this.position.layoutBodyLeft) $('#consoleBody > .row > .span3 > .nav-list').append(e.body);
                if (e.pos == this.position.layoutBodyMain) $('#consoleBody').append(e.body);
            }
        },

        setup : function() {
            $('body').append(this.layout.header,this.layout.body,this.layout.footer);
            $.each(this.widgets, $.proxy(function(i, e) {
                if (this.auth.authorized || !e.options.authonly) {
                    if (!this.widgets[i].installed) {
                        this.layout.add(e);
                        if (e.options.ready != null) e.options.ready();
                        this.widgets[i].installed = true;
                    }
                }
            }, this));
        },

        uninstallwidgets: function() {
            $.each(this.widgets, function() {
                if (this.installed && this.options.authonly) {
                    this.body.remove();
                    this.installed = false;
                }
            }, this);
        }
    }

    root.Widget = function(n, p, f, o) {
        this.name = n != null ? n : "widget";
        this.pos = p != null ? p : "none";
        this.float = f != null ? f : "none";
        this.options = $.extend({
            authonly: true,
            // Функция которая вызывается после того как виджет добавлен
            ready: null
        }, o);
        this.body = null;
        this.installed = false;
    }

    root.Console = new Console();
}(window.jQuery);

!function($) {
    var auth = root.Console.auth;
    var authorizer = new root.Widget("authorizer", root.Console.layout.position.layoutHeader, "right", { authonly: false });
    var getauth = function () {
        $.ajax({
            url: siteroot+"_sys/whoami.json.qweb",
            context: this,
            dataType: 'json'
        }).success($.proxy(function(d) {
            loginpreloader.hide();
            auth.logonname = d.logonname;
            auth.admin = d.logonadmin;
            auth.datamaster = d.logondatamaster;
            auth.developer = d.logondeveloper;
            if (d.logonname != "") {
                auth.authorized = true;
                loginform.hide();
                logininfo.show();
            } else {
                auth.authorized = false;
                loginform.show();
                logininfo.hide();
            }
            logininfolabel.html(d.logonname);
            roletooltipconfigure();
            window.qorpent.security.Console.setup();
        }, this));
    };
    getauth();
    var authorize = function() {
        loginform.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/login.json.qweb",
            context: this,
            data: {
                _l_o_g_i_n_: loginfield.val(),
                _p_a_s_s_: passfield.val()
            },
            dataType: 'json'
        }).success(function(d) {
                getauth();
            });
    }
    var unauthorize = function() {
        logininfo.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/logout.json.qweb",
            context: this
        }).success(function(d) {
                getauth();
                window.qorpent.security.Console.uninstallwidgets();
            });
    }
    var loginfield = $('<input class="input-small" type="text" placeholder="Логин" autocomplete/>');
    var passfield = $('<input class="input-small" type="password" placeholder="Пароль"/>');
    var loginform = $('<form/>', { "class": "navbar-form login-form"})
        .submit(function(e) {
            e.preventDefault();
            authorize();
        })
        .append( loginfield, passfield,
        $("<button/>", {
            "class" : "btn btn-small",
            "type" : "submit",
            "text" : "Войти"
        })
    ).hide();
    var logininfolabel = $('<span class="login-user label label-inverse" />');
    var loginpreloader = $('<img/>', { "class": "preloader", "src": siteroot + "/img/300.gif" });
    var logininfo = $('<div class="login-info"/>').append(
        logininfolabel,
        $('<button/>', {
            "class" : "btn btn-small",
            "type" : "button",
            "text" : "Выйти",
            "click": function() {unauthorize()}
        })
    ).hide();
    var roletooltipconfigure = function() {
        var roleinfo = $('<div/>').append($('<ul class="login-permissions"/>').css({
            "list-style-type" : "none",
            "margin": "0",
            "text-align": "left"
        }).append(
            $("<li/>").html(auth.admin == true ? 'Administrator<span>YES</span>' : 'Administrator NO'),
            $("<li/>").html(auth.developer == true ? 'Developer<span>YES</span>' : 'Developer NO'),
            $("<li/>").html(auth.datamaster == true ? 'Datamaster<span>YES</span>' : 'Datamaster NO')
        ));
        $(logininfolabel).tooltip({title: roleinfo.html(), placement: 'bottom', html: true});
    }
    authorizer.body = $('<div/>').append(loginform, loginpreloader, logininfo);
    root.Console.registerWidget(authorizer);
}(window.jQuery);

!function($) {
    var zefsstatus = new root.Widget("zefsstatus", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var status = $('<span class="label"/>').text("Статус сервера");
    zefsstatus.body = $('<div/>').append(status);
    //root.Console.registerWidget(zefsstatus);
}(window.jQuery);

!function($) {
    var zefsdebug = new root.Widget("zefsdebug", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var session = $('<a id="sessionInfo"/>')
        .click(function(e) { debug("zefs/session.json.qweb?session=" + $(this).attr("uid"), "Данные о сессии") })
        .html('<i class="icon-globe"></i> Информация о сессии');
    var debuginfo = $('<a id="debugInfo"/>')
        .click(function(e) { debug("zefs/debuginfo.json.qweb?session=" + $(this).attr("uid"), "Отладочные данные") })
        .html('<i class="icon-warning-sign"></i> Отладочная информация');
    var restart = $('<a id="restartInfo"/>')
        .click(function(e) { debug("zefs/restart.json.qweb", "Рестарт приложения") })
        .html('<i class="icon-repeat"></i> Рестарт');
    var lock = $('<a id="currentlockInfo"/>')
        .click(function(e) { debug("zefs/currentlockstate.json.qweb?session=" + $(this).attr("uid"), "Статус блокировки") })
        .html('<i class="icon-lock"></i> Текущий статус');
    var serverstatus = $('<a id="serverInfo"/>')
        .click(function(e) { debug("zefs/server.json.qweb", "Статус сервера") })
        .html('<i class="icon-tasks"></i> Статус сервера');
    var canlock = $('<a id="canlockInfo"/>')
        .click(function(e) { debug("zefs/canlockstate.json.qweb?session=" + $(this).attr("uid"), "Возможность блокировки") })
        .html('<i class="icon-lock"></i> Возможность блокровки');

    var btngroup = $('<div class="btn-group"/>').append(
        $('<button class="btn btn-small dropdown-toggle" data-toggle="dropdown"/>').html('<i class="icon-eye-close"></i><span class="caret"></span>'),
        $('<ul class="dropdown-menu"/>').append(
            $('<li/>').append(lock),$('<li/>').append(canlock),$('<li/>').append(session),$('<li/>').append(debuginfo),$('<li class="divider"/>'),
            $('<li/>').append(serverstatus),$('<li class="divider"/>'), $('<li/>').append(restart)
        ));
    var debug = function(command, title) {
        var modal = $('<div class="modal" role="dialog" />');
        var iframe = $('<iframe id="debugResult"/>').attr("src", command);
        var modalheader = $("<div/>", {"class":"modal-header"}).append(
            $('<button type="button" class="close" data-dismiss="modal" aria-hidden="true" />').html("&times;"),
            $('<h3/>').text(title));
        var modalbody = $('<div class="modal-body" />').append(iframe);
        var modalfooter = $('<div class="modal-footer"/>').append(
            $('<a href="#" class="btn btn-primary" data-dismiss="modal" />')
                .html("Закрыть"));
        modal.append(modalheader, modalbody, modalfooter);
        $(modal).modal({backdrop: false});

        // Убиваем окно после его закрытия
        $(modal).on('hidden', function(e) { $(this).remove() });
        $(modal).draggable();
    }
    zefsdebug.body = $('<div/>').append(btngroup);
    root.Console.registerWidget(zefsdebug);
}(window.jQuery);

!function($) {
    var zefsformheader = new root.Widget("zefsformheader", root.Console.layout.position.layoutBodyMain, null, { authonly: true });
    zefsformheader.body = $('<h3 id="zefsFormHeader"/>');
    root.Console.registerWidget(zefsformheader);
}(window.jQuery);

!function($) {
    var zefsform = new root.Widget("zefsform", root.Console.layout.position.layoutBodyMain, null, { authonly: true, ready: function() { window.zefs.init(jQuery) } });
    zefsform.body = $('<table class="data" id="zefsForm"/>');
    root.Console.registerWidget(zefsform);
}(window.jQuery);

!function($) {
    var zefsobjselector = new root.Widget("objselector", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var list = $('<div class="btn-group"/>').append(
        $('<button class="btn btn-small dropdown-toggle" data-toggle="dropdown"/>').html('<i class="icon-calendar"></i><span class="caret"/>'),
        $('<ul class="dropdown-menu"/>').append(
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Месяцы'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="11">Январь</a>'),
                    $('<li/>').html('<a value="11">Февраль</a>'),
                    $('<li/>').html('<a value="11">Март</a>'),
                    $('<li/>').html('<a value="11">Апрель</a>'),
                    $('<li/>').html('<a value="11">Май</a>'),
                    $('<li/>').html('<a value="11">Июнь</a>'),
                    $('<li/>').html('<a value="11">Июль</a>'),
                    $('<li/>').html('<a value="11">Август</a>'),
                    $('<li/>').html('<a value="11">Сентябрь</a>'),
                    $('<li/>').html('<a value="11">Октябрь</a>'),
                    $('<li/>').html('<a value="11">Ноябрь</a>'),
                    $('<li/>').html('<a value="11">Декабрь</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('С начала года'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="11">3 мес.</a>'),
                    $('<li/>').html('<a value="11">6 мес.</a>'),
                    $('<li/>').html('<a value="11">9 мес.</a>'),
                    $('<li/>').html('<a value="11">12 мес.</a>'),
                    $('<li/>').html('<a value="11">II квартал</a>'),
                    $('<li/>').html('<a value="11">III квартал</a>'),
                    $('<li/>').html('<a value="11">IV квартал</a>'),
                    $('<li/>').html('<a value="11">II п/г</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Промежуточные периоды'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="11">2 мес.</a>'),
                    $('<li/>').html('<a value="11">4 мес.</a>'),
                    $('<li/>').html('<a value="11">5 мес.</a>'),
                    $('<li/>').html('<a value="11">7 мес.</a>'),
                    $('<li/>').html('<a value="11">8 мес.</a>'),
                    $('<li/>').html('<a value="11">10 мес.</a>'),
                    $('<li/>').html('<a value="11">11 мес.</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Плановые периоды'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="11">ТПФП (действующий)</a>'),
                    $('<li/>').html('<a value="11">ТПФП, на директорат</a>'),
                    $('<li/>').html('<a value="11">План I кв.</a>'),
                    $('<li/>').html('<a value="11">План I пг.</a>'),
                    $('<li/>').html('<a value="11">План 9 мес.</a>'),
                    $('<li/>').html('<a value="11">План II кв.</a>'),
                    $('<li/>').html('<a value="11">План III кв.</a>'),
                    $('<li/>').html('<a value="11">План IV кв.</a>'),
                    $('<li/>').html('<a value="11">План II пг.</a>'),
                    $('<li/>').html('<a value="11">ТПФП, версия 1</a>'),
                    $('<li/>').html('<a value="11">ТПФП, версия 2</a>'),
                    $('<li/>').html('<a value="11">ТПФП, версия 3</a>'),
                    $('<li/>').html('<a value="11">ТПФП, версия 4</a>')
                )
            )
        )
    )
    zefsobjselector.body = $('<div/>').append(list);
    root.Console.registerWidget(zefsobjselector);
}(window.jQuery);