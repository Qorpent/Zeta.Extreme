var siteroot = document.location.pathname.match("^/([\\w\\d_\-]+)?/")[0];
var root = window.qorpent = window.qorpent || {};
//root = root.zeta = root.zeta || {};
root = root.security = root.security || {};

!function($) {
    var Console = function() {
        this.auth = {
            admin : false,
            developer : false,
            datamaster : false,
            authorized : false,
            logonname : ""
        }

        this.roles = []
    }

    Console.prototype = {
        widgets : [],
        registerWidget : function(e) {
            this.widgets.push(e);
        },
        // Setup layout
        layout : {
            position : {
                layoutHeader : "header",
//              layoutBodyLeft : "body-left",
                layoutBodyMain : "body-main"
            },
            header : $('<div id="consoleHeader"/>').append(
                $('<div class="navbar"/>').append(
                    $('<div class="navbar-inner"/>')
                )
            ),
            body : $('<div id="consoleBody" class="container console-body"/>').append(
                $('<div/>').append($('<section/>'))
                /*$('<div class="span3 console-sidebar" />').append($('<ul class="nav nav-list"/>')),
                 $('<div class="span9" />').append($('<section/>'))*/
            ),
            footer : $('<div id="consoleFooter"/>'),
            add : function(e) {
                $(e.body).addClass(e.name)
                if (e.float != "none") $(e.body).addClass("pull-" + e.float)
                if (e.pos == this.position.layoutHeader) $('#consoleHeader > .navbar > .navbar-inner').append(e.body);
                //  if (e.pos == this.position.layoutBodyLeft) $('#consoleBody > .row > .span3 > .nav-list').append(e.body);
                if (e.pos == this.position.layoutBodyMain) $('#consoleBody > div > section').append(e.body);
            }
        },

        setup : function() {
            $('body').append(this.layout.header,this.layout.body,this.layout.footer);
            $.each(this.widgets, $.proxy(function(i, e) {
                if (this.auth.authorized || !e.options.authonly) {
                    if (!this.widgets[i].installed) {
                        this.layout.add(e);
                        this.widgets[i].installed = true;
                    }
                }
            }, this));
        },

        uninstallwidgets: function() {
            $.each(this.widgets, function() {
                if (this.installed && this.options.authonly) {
                    this.body.remove();
                    this.installed = false;
                }
            }, this);
        }
    }

    root.Widget = function(n, p, f, o) {
        this.name = n != null ? n : "widget";
        this.pos = p != null ? p : "none";
        this.float = f != null ? f : "none";
        this.options = $.extend({
            authonly: true
        }, o);
        this.body = null;
        this.installed = false;
    }

    root.Console = new Console();
}(window.jQuery);

!function($) {
    var auth = root.Console.auth;
    var authorizer = new root.Widget("authorizer", root.Console.layout.position.layoutHeader, "right", { authonly: false });
    var getauth = function () {
        $.ajax({
            url: siteroot+"_sys/whoami.json.qweb",
            context: this,
            dataType: 'json'
        }).success($.proxy(function(d) {
            loginpreloader.hide();
            auth.logonname = d.logonname;
            auth.admin = d.logonadmin;
            auth.datamaster = d.logondatamaster;
            auth.developer = d.logondeveloper;
            if (d.logonname != "") {
                auth.authorized = true;
                loginform.hide();
                logininfo.show();
            } else {
                auth.authorized = false;
                loginform.show();
                logininfo.hide();
            }
            logininfolabel.html(d.logonname);
            roletooltipconfigure();
            window.qorpent.security.Console.setup();
        }, this));
    };
    getauth();
    var authorize = function() {
        loginform.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/login.json.qweb",
            context: this,
            data: {
                _l_o_g_i_n_: loginfield.val(),
                _p_a_s_s_: passfield.val()
            },
            dataType: 'json'
        }).success(function(d) {
                getauth();
            });
    }
    var unauthorize = function() {
        logininfo.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/logout.json.qweb",
            context: this
        }).success(function(d) {
                getauth();
                window.qorpent.security.Console.uninstallwidgets();
            });
    }
    var loginfield = $('<input class="input-small" type="text" placeholder="Логин" autocomplete/>');
    var passfield = $('<input class="input-small" type="password" placeholder="Пароль"/>');
    var loginform = $('<form/>', { "class": "navbar-form login-form"})
        .submit(function(e) {
            e.preventDefault();
            authorize();
        })
        .append( loginfield, passfield,
        $("<button/>", {
            "class" : "btn",
            "type" : "submit",
            "text" : "Войти"
        })
    ).hide();
    var logininfolabel = $('<span class="login-user label label-success" />');
    var loginpreloader = $('<img/>', { "class": "preloader", "src": siteroot + "/img/300.gif" });
    var logininfo = $('<div class="login-info"/>').append(
        logininfolabel,
        $('<button/>', {
            "class" : "btn",
            "type" : "button",
            "text" : "Выйти",
            "click": function() {unauthorize()}
        })
    ).hide();
    var roletooltipconfigure = function() {
        var roleinfo = $('<div/>').append($('<ul class="login-permissions"/>').css({
            "list-style-type" : "none",
            "margin": "0",
            "text-align": "left"
        }).append(
            $("<li/>").html(auth.admin == true ? 'Administrator<span>YES</span>' : 'Administrator NO'),
            $("<li/>").html(auth.developer == true ? 'Developer<span>YES</span>' : 'Developer NO'),
            $("<li/>").html(auth.datamaster == true ? 'Datamaster<span>YES</span>' : 'Datamaster NO')
        ));
        $(logininfolabel).tooltip({title: roleinfo.html(), placement: 'bottom', html: true});
    }
    authorizer.body = $('<div/>').append(loginform, loginpreloader, logininfo);
    root.Console.registerWidget(authorizer);
}(window.jQuery);

!function($) {
    var auth = root.Console.auth;
    var sessionInfo = new root.Widget("sessioninfo", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var session = $('<a class="btn" id="sessionInfo" />')
        .css("margin","2px").html('<i class="icon-globe"></i>Сессия');
    var debug = $('<a class="btn" id="debugInfo" />')
        .css("margin","2px").html('<i class="icon-warning-sign"></i>Debug');
    sessionInfo.body = $('<div/>').append(session, debug);
    root.Console.registerWidget(sessionInfo);
}(window.jQuery);