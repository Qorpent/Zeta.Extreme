var siteroot = document.location.pathname.match("^/([\\w\\d_\-]+)?/")[0];
var root = window.qorpent = window.qorpent || {};
//root = root.zeta = root.zeta || {};
root = root.security = root.security || {};

!function($) {
    var Console = function() {
        this.auth = {
            admin : false,
            developer : false,
            datamaster : false,
            authorized : false,
            logonname : ""
        }

        this.roles = []
    }

    Console.prototype = {
        widgets : [],
        registerWidget : function(e) {
            this.widgets.push(e);
        },
        // Setup layout
        layout : {
            position : {
                layoutHeader : "header",
//              layoutBodyLeft : "body-left",
                layoutBodyMain : "body-main"
            },
            header : $('<div id="consoleHeader"/>').append(
                $('<div class="navbar"/>').append(
                    $('<div class="navbar-inner"/>')
                )
            ),
            body : $('<div id="consoleBody" class="console-body"/>'),
            /*.append($('<div/>').append($('<section/>'))
                $('<div class="span3 console-sidebar" />').append($('<ul class="nav nav-list"/>')),
                 $('<div class="span9" />').append($('<section/>'))
            ),*/
            footer : $('<div id="consoleFooter"/>'),
            add : function(e) {
                $(e.body).addClass(e.name)
                if (e.float != "none") $(e.body).addClass("pull-" + e.float)
                if (e.pos == this.position.layoutHeader) $('#consoleHeader > .navbar > .navbar-inner').append(e.body);
                //  if (e.pos == this.position.layoutBodyLeft) $('#consoleBody > .row > .span3 > .nav-list').append(e.body);
                if (e.pos == this.position.layoutBodyMain) $('#consoleBody').append(e.body);
            }
        },

        setup : function() {
            $('body').append(this.layout.header,this.layout.body,this.layout.footer);
            $.each(this.widgets, $.proxy(function(i, e) {
                if (this.auth.authorized || !e.options.authonly) {
                    if (!this.widgets[i].installed) {
                        this.layout.add(e);
                        if (e.options.ready != null) e.options.ready();
                        this.widgets[i].installed = true;
                    }
                }
            }, this));
        },

        uninstallwidgets: function() {
            $.each(this.widgets, function() {
                if (this.installed && this.options.authonly) {
                    this.body.remove();
                    this.installed = false;
                }
            }, this);
        }
    }

    root.Widget = function(n, p, f, o) {
        this.name = n != null ? n : "widget";
        this.pos = p != null ? p : "none";
        this.float = f != null ? f : "none";
        this.options = $.extend({
            authonly: true,
            // Функция которая вызывается после того как виджет добавлен
            ready: null
        }, o);
        this.body = null;
        this.installed = false;
    }

    root.Console = new Console();
}(window.jQuery);


/**
 * Виджет инструментов для отладки
 */
!function($) {
    var zefsdebug = new root.Widget("zefsdebug", root.Console.layout.position.layoutHeader, "right", { authonly: true });
    var session = $('<a id="sessionInfo"/>')
        .click(function(e) { debug("zefs/session.json.qweb?session=" + $(this).attr("uid"), "Данные о сессии") })
        .html('<i class="icon-globe"></i> Информация о сессии');
    var debuginfo = $('<a id="debugInfo"/>')
        .click(function(e) { debug("zefs/debuginfo.json.qweb?session=" + $(this).attr("uid"), "Отладочные данные") })
        .html('<i class="icon-warning-sign"></i> Отладочная информация');
    var restart = $('<a id="restartInfo"/>')
        .click(function(e) { debug("zefs/restart.json.qweb", "Рестарт приложения") })
        .html('<i class="icon-repeat"></i> Рестарт');
    var lock = $('<a id="currentlockInfo"/>')
        .click(function(e) { debug("zefs/currentlockstate.json.qweb?session=" + $(this).attr("uid"), "Статус блокировки") })
        .html('<i class="icon-lock"></i> Текущий статус');
    var serverstatus = $('<a id="serverInfo"/>')
        .click(function(e) { debug("zefs/server.json.qweb", "Статус сервера") })
        .html('<i class="icon-tasks"></i> Статус сервера');
    var canlock = $('<a id="canlockInfo"/>')
        .click(function(e) { debug("zefs/canlockstate.json.qweb?session=" + $(this).attr("uid"), "Возможность блокировки") })
        .html('<i class="icon-lock"></i> Возможность блокровки');

    var btngroup = $('<div class="btn-group pull-right"/>').append(
        $('<button class="btn btn-small dropdown-toggle" title="Отладка" data-toggle="dropdown"/>').html('<i class="icon-eye-close"></i><span class="caret"></span>'),
        $('<ul class="dropdown-menu"/>').append(
            $('<li/>').append(lock),$('<li/>').append(canlock),$('<li/>').append(session),$('<li/>').append(debuginfo),$('<li class="divider"/>'),
            $('<li/>').append(serverstatus),$('<li class="divider"/>'), $('<li/>').append(restart)
        ));
    var debug = function(command, title) {
        var modal = $('<div class="modal" role="dialog" />');
        var iframe = $('<iframe id="debugResult"/>').attr("src", command);
        var modalheader = $("<div/>", {"class":"modal-header"}).append(
            $('<button type="button" class="close" data-dismiss="modal" aria-hidden="true" />').html("&times;"),
            $('<h3/>').text(title));
        var modalbody = $('<div class="modal-body" />').append(iframe);
        var modalfooter = $('<div class="modal-footer"/>').append(
            $('<a href="#" class="btn btn-primary" data-dismiss="modal" />')
                .html("Закрыть"));
        modal.append(modalheader, modalbody, modalfooter);
        $(modal).modal({backdrop: false});

        // Убиваем окно после его закрытия
        $(modal).on('hidden', function(e) { $(this).remove() });
        $(modal).draggable();
    }
    $(window.zefs).on("session_load", function() {
        session.attr("uid",zefs.myform.sessionId);
        debuginfo.attr("uid",zefs.myform.sessionId);
        lock.attr("uid",zefs.myform.sessionId);
        canlock.attr("uid",zefs.myform.sessionId);
    });
    zefsdebug.body = $('<div/>').append(btngroup);
    root.Console.registerWidget(zefsdebug);
}(window.jQuery);

!function($) {
    var auth = root.Console.auth;
    var authorizer = new root.Widget("authorizer", root.Console.layout.position.layoutHeader, "right", { authonly: false });
    var getauth = function () {
        $.ajax({
            url: siteroot+"_sys/whoami.json.qweb",
            context: this,
            dataType: 'json'
        }).success($.proxy(function(d) {
            loginpreloader.hide();
            auth.logonname = d.logonname;
            auth.admin = d.logonadmin;
            auth.datamaster = d.logondatamaster;
            auth.developer = d.logondeveloper;
            if (d.logonname != "") {
                auth.authorized = true;
                loginform.hide();
                logininfo.show();
            } else {
                auth.authorized = false;
                loginform.show();
                logininfo.hide();
            }
            logininfolabel.html(d.logonname);
            roletooltipconfigure();
            window.qorpent.security.Console.setup();
        }, this));
    };
    getauth();
    var authorize = function() {
        loginform.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/login.json.qweb",
            type: "POST",
            context: this,
            data: {
                _l_o_g_i_n_: loginfield.val(),
                _p_a_s_s_: passfield.val()
            },
            dataType: 'json'
        }).success(function(d) {
                getauth();
            });
    }
    var unauthorize = function() {
        logininfo.hide();
        loginpreloader.show();
        $.ajax({
            url: siteroot+"_sys/logout.json.qweb",
            context: this
        }).success(function(d) {
                getauth();
                window.qorpent.security.Console.uninstallwidgets();
            });
    }
    var loginfield = $('<input class="input-small" type="text" placeholder="Логин" autocomplete/>');
    var passfield = $('<input class="input-small" type="password" placeholder="Пароль"/>');
    var loginform = $('<form/>', { "class": "navbar-form login-form"})
        .submit(function(e) {
            e.preventDefault();
            authorize();
        })
        .append( loginfield, passfield,
        $("<button/>", {
            "class" : "btn btn-small",
            "type" : "submit",
            "text" : "Войти"
        })
    ).hide();
    var logininfolabel = $('<span class="login-user label label-inverse" />');
    var loginpreloader = $('<img/>', { "class": "preloader", "src": siteroot + "/img/300.gif" });
    var logininfo = $('<div class="login-info"/>').append(
        logininfolabel,
        $('<button/>', {
            "class" : "btn btn-small",
            "type" : "button",
            "text" : "Выйти",
            "click": function() {unauthorize()}
        })
    ).hide();
    var roletooltipconfigure = function() {
        var roleinfo = $('<div/>').append($('<ul class="login-permissions"/>').css({
            "list-style-type" : "none",
            "margin": "0",
            "text-align": "left"
        }).append(
            $("<li/>").html(auth.admin == true ? 'Administrator<span>YES</span>' : 'Administrator NO'),
            $("<li/>").html(auth.developer == true ? 'Developer<span>YES</span>' : 'Developer NO'),
            $("<li/>").html(auth.datamaster == true ? 'Datamaster<span>YES</span>' : 'Datamaster NO')
        ));
        $(logininfolabel).tooltip({title: roleinfo.html(), placement: 'bottom', html: true});
    }
    authorizer.body = $('<div/>').append(loginform, loginpreloader, logininfo);
    root.Console.registerWidget(authorizer);
}(window.jQuery);

/**
 * Виджет индикатора состояния сервера.
 * Временно отключен, так как планируется передалать на Алерты, выпадающие сверху таблицы
 */
!function($) {
    var zefsstatus = new root.Widget("zefsstatus", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var status = $('<span class="label"/>').text("Статус сервера");
    zefsstatus.body = $('<div/>').append(status);
    //root.Console.registerWidget(zefsstatus);
}(window.jQuery);

/**
 * Виджет инструмента для сохранения формы
 */
!function($) {
    var zefsformsave = new root.Widget("zefsformsave", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var b = $('<button class="btn btn-small btn-primary" title="Сохранить форму" />').html('<i class="icon-ok icon-white"/>');
    b.click(function(e) {
       zefs.myform.save(window.zefs.myform.getChanges());
    });
    $(window.zefs).on(window.zefs.handlers.on_getlockload, function() {
        if (!zefs.myform.lock) {
            b.attr("disabled", "disabled");
        }
    });
    $(window.zefs).on(window.zefs.handlers.on_savestart, function() {
        b.attr("disabled", "disabled");
    });
    $(window.zefs).on(window.zefs.handlers.on_savefinished, function() {
        b.removeAttr("disabled");
    });
    zefsformsave.body = $('<div/>').append(b);
    root.Console.registerWidget(zefsformsave);
}(window.jQuery);

/**
 * Виджет обратной связи
 */
!function($) {
    var feedback = new root.Widget("feedback", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var b = $('<button class="btn btn-small btn-warning" title="Обратная связь" />').html('<i class="icon-envelope icon-white"></i>');
    feedback.body = $('<div/>').append(b);
    root.Console.registerWidget(feedback);
}(window.jQuery);

/**
 * Виджет информационного меню
 */
!function($) {
    var information = new root.Widget("information", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var m = $('<div class="btn-group"/>').append(
        $('<button class="btn btn-small dropdown-toggle" data-toggle="dropdown" title="Информация"/>').html('<i class="icon-book"></i><span class="caret"></span>'),
        $('<ul class="dropdown-menu"/>').append(
            $('<li/>').html('<a>Инструкция пользователя</a>'),
            $('<li/>').html('<a>Справка по форме</a>'),
            $('<li class="divider"/>'),
            $('<li/>').html('<a>О программе</a>')
        ));
    information.body = $('<div/>').append(m);
    root.Console.registerWidget(information);
}(window.jQuery);

/**
 * Виджет заголовка таблицы
 */
!function($) {
    var zefsformheader = new root.Widget("zefsformheader", root.Console.layout.position.layoutBodyMain, null, { authonly: true });
    var h = $('<h3/>');
    zefsformheader.body = $('<div/>').append(h);
    $(window.zefs).on(window.zefs.handlers.on_sessionload, function() {
        h.text(
           zefs.myform.currentSession.getFormInfo().getName() + " " +
           zefs.myform.currentSession.getObjInfo().getName() + " за /period_name/, " +
        // zefs.myform.currentSession.getPeriod() + ", " +
           zefs.myform.currentSession.getYear() + " год"
        );
    });
    $(window.zefs).on(window.zefs.handlers.on_periodsload, function() {
        h.text(zefsformheader.body.text().replace('/period_name/',zefs.getperiodbyid(window.zefs.options.getParameters().period)));
    });
    root.Console.registerWidget(zefsformheader);
}(window.jQuery);

/**
 * Виджет Zefs-формы
 */
!function($) {
    var zefsform = new root.Widget("zefsform", root.Console.layout.position.layoutBodyMain, null, { authonly: true, ready: function() {
       zefs.init(jQuery);
       zefs.myform.run();
    } });
    zefsform.body = $('<table class="data" id="zefsForm"/>');
    $(window.zefs).on(window.zefs.handlers.on_getlockload, function() {
        if (!zefs.myform.lock) {
            zefsform.body.addClass("isblocked");
        }
    });
    root.Console.registerWidget(zefsform);
}(window.jQuery);

/**
 * Виджет списка периодов
 */
!function($) {
    var zefsperiodselector = new root.Widget("objselector", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var list = $('<div class="btn-group"/>');
    var b = $('<button class="btn btn-small dropdown-toggle" data-toggle="dropdown" title="Период"/>').html('<i class="icon-calendar"></i><span class="caret"/>');
    var menu = $('<ul class="dropdown-menu"/>');
    menu.append(
        $('<li class="dropdown-submenu" type="Month"/>').append($('<a/>').text('Месяцы')),
        $('<li class="dropdown-submenu" type="FromYearStartMain"/>').append($('<a/>').text('С начала года')),
        $('<li class="dropdown-submenu" type="FromYearStartExt"/>').append($('<a/>').text('Промежуточные периоды')),
        $('<li class="dropdown-submenu" type="Plan"/>').append($('<a/>').text('Плановые периоды')),
        $('<li class="dropdown-submenu" type="MonthPlan"/>').append($('<a/>').text('Плановые (месячные) периоды')),
        $('<li class="dropdown-submenu" type="Corrective"/>').append($('<a/>').text('Коррективы плана')),
        $('<li class="dropdown-submenu" type="Awaited"/>').append($('<a/>').text('Ожидаемые периоды'))/*,
        $('<li class="dropdown-submenu" type="Ext"/>').append($('<a/>').text('Дополнительные'))*/
    );
    list.append(b,menu);
    var ChangePeriod = function(e) {
        var type = $($(e.target).parents()[2]).attr("type");
        if (type.search("Plan") != -1) location.hash = location.hash.replace(/[ABC].in/gi,'B.in');
        else if (type == "Corrective") location.hash = location.hash.replace(/[ABC].in/gi,'C.in');
        else location.hash = location.hash.replace(/[ABC].in/gi,'A.in');
        location.hash = location.hash.replace(/period=\d+/gi,"period=" + $(e.target).attr("value"));
        location.reload();
    };
    $(window.zefs).on(window.zefs.handlers.on_periodsload, function(e) {
        $.each(window.zefs.periods, function(periodname,periodtype) {
            var litype = menu.find('li[type=' + periodname + ']');
            if (litype.length != 0) {
                var ul = $('<ul class="dropdown-menu"/>');
                $.each(periodtype, function(i,period) {
                    var a = $('<a/>').attr("value", period.getId());
                    a.click(function(e) {
                        ChangePeriod(e);
                    });
                    a.text(period.getName());
                    ul.append($('<li/>').append(a));
                });
                litype.append(ul);
            }
        })
    });
/*        $('<ul class="dropdown-menu"/>').append(
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Месяцы'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="11">Январь</a>'),
                    $('<li/>').html('<a value="12">Февраль</a>'),
                    $('<li/>').html('<a value="13">Март</a>'),
                    $('<li/>').html('<a value="14">Апрель</a>'),
                    $('<li/>').html('<a value="15">Май</a>'),
                    $('<li/>').html('<a value="16">Июнь</a>'),
                    $('<li/>').html('<a value="17">Июль</a>'),
                    $('<li/>').html('<a value="18">Август</a>'),
                    $('<li/>').html('<a value="19">Сентябрь</a>'),
                    $('<li/>').html('<a value="110">Октябрь</a>'),
                    $('<li/>').html('<a value="111">Ноябрь</a>'),
                    $('<li/>').html('<a value="112">Декабрь</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('С начала года'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="1">3 мес.</a>'),
                    $('<li/>').html('<a value="2">6 мес.</a>'),
                    $('<li/>').html('<a value="3">9 мес.</a>'),
                    $('<li/>').html('<a value="4">12 мес.</a>'),
                    $('<li/>').html('<a value="42">II квартал</a>'),
                    $('<li/>').html('<a value="43">III квартал</a>'),
                    $('<li/>').html('<a value="44">IV квартал</a>'),
                    $('<li/>').html('<a value="46">II п/г</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Промежуточные периоды'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="22">2 мес.</a>'),
                    $('<li/>').html('<a value="24">4 мес.</a>'),
                    $('<li/>').html('<a value="25">5 мес.</a>'),
                    $('<li/>').html('<a value="27">7 мес.</a>'),
                    $('<li/>').html('<a value="28">8 мес.</a>'),
                    $('<li/>').html('<a value="210">10 мес.</a>'),
                    $('<li/>').html('<a value="211">11 мес.</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Плановые периоды'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="301">ТПФП (действующий)</a>'),
                    $('<li/>').html('<a value="3512">ТПФП, на директорат</a>'),
                    $('<li/>').html('<a value="303">План I кв.</a>'),
                    $('<li/>').html('<a value="306">План I пг.</a>'),
                    $('<li/>').html('<a value="309">План 9 мес.</a>'),
                    $('<li/>').html('<a value="642">План II кв.</a>'),
                    $('<li/>').html('<a value="643">План III кв.</a>'),
                    $('<li/>').html('<a value="644">План IV кв.</a>'),
                    $('<li/>').html('<a value="646">План II пг.</a>'),
                    $('<li/>').html('<a value="251">ТПФП, версия 1</a>'),
                    $('<li/>').html('<a value="252">ТПФП, версия 2</a>'),
                    $('<li/>').html('<a value="253">ТПФП, версия 3</a>'),
                    $('<li/>').html('<a value="254">ТПФП, версия 4</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Коррективы плана'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="31">Корректив 1</a>'),
                    $('<li/>').html('<a value="32">Корректив 2</a>'),
                    $('<li/>').html('<a value="33">Корректив 3</a>'),
                    $('<li/>').html('<a value="34">Корректив 4</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Ожидаемые периоды'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="403">Ожидаемое за I кв.</a>'),
                    $('<li/>').html('<a value="416">Ожидаемое за июнь</a>'),
                    $('<li/>').html('<a value="406">Ожидаемое за I пг.</a>'),
                    $('<li/>').html('<a value="409">Ожидаемое за 9 мес.</a>'),
                    $('<li/>').html('<a value="401">Ожидаемое за год</a>')
                )
            ),
            $('<li class="dropdown-submenu"/>').append(
                $('<a/>').text('Дополнительно'),
                $('<ul class="dropdown-menu"/>').append(
                    $('<li/>').html('<a value="302">Общий план</a>'),
                    $('<li/>').html('<a value="-1">Начало года</a>'),
                    $('<li/>').html('<a value="1000">Конец года</a>'),
                    $('<li/>').html('<a value="-99">Некорректный период</a>')
                )
            )
        )*/
    zefsperiodselector.body = $('<div/>').append(list);
    root.Console.registerWidget(zefsperiodselector);
}(window.jQuery);

/**
 * Виджет списка предприятий
 */
!function($) {
    var zefsobjselector = new root.Widget("objselector", root.Console.layout.position.layoutHeader, "left", { authonly: true });
    var list = $('<div class="btn-group"/>');
    var b = $('<button class="btn btn-small dropdown-toggle" data-toggle="dropdown" title="Предприятие"/>').html('<i class="icon-map-marker"></i><span class="caret"/>');
    var menu = $('<ul class="dropdown-menu"/>');
    list.append(b,menu);
    var ChangeObject = function(e) {
        location.hash = location.hash.replace(/obj=\d+/gi,"obj=" + $(e.target).attr("value"));
        location.reload();
    };
    $(window.zefs).on(window.zefs.handlers.on_objectsload, function(e) {
        $.each(window.zefs.divs, function(i,div) {
            menu.append($('<li class="dropdown-submenu"/>')
                .append($('<a/>').text(div.getName()), $('<ul class="dropdown-menu"/>').attr("code", div.getCode())));
        });
        $.each(window.zefs.objects, function(i,obj) {
            var ul = menu.find('ul[code=' + obj.getDivCode() + ']');
            if (ul.length != 0) {
                var a = $('<a/>').attr("value", obj.getId());
                a.click(function(e) {
                    ChangeObject(e);
                });
                a.text(obj.getName());
                ul.append($('<li/>').append(a));
            }
        });
    });
    zefsobjselector.body = $('<div/>').append(list);
    root.Console.registerWidget(zefsobjselector);
}(window.jQuery);

/**
 * Виджет окна с сообщениями
 */
!function($) {
    var zefsalerter = new root.Widget("zefsalerter", root.Console.layout.position.layoutBodyMain, null, { authonly: true });
//    var alert =

    zefsalerter.body = $('<div/>').append();
    root.Console.registerWidget(zefsalerter);
}(window.jQuery);